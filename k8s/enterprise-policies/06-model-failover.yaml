##############################################################################
# 6. MODEL FAILOVER / ROUTING
#
# API Group:   agentgateway.dev/v1alpha1
# Kind:        AgentgatewayBackend
#
# Purpose:     Configure multi-model failover with priority groups so the
#              credit limit agent always has an available LLM, even if the
#              primary model goes down.
#
# Banking Use Case:
#   - Primary: GPT-4.1 for highest-quality credit assessments.
#   - Secondary: GPT-4o-mini for cost-effective fallback.
#   - Tertiary: GPT-3.5-turbo as last-resort fallback.
#   - Ensures credit limit processing never stops due to a single
#     model outage -- critical for bank SLA compliance.
#   - Multi-provider failover (OpenAI + Anthropic) for maximum resilience.
#
# Docs: https://docs.solo.io/agentgateway/2.1.x/llm/failover/
##############################################################################
---
# Single-provider failover: OpenAI models with priority ordering
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: bank-llm-failover
  namespace: agentgateway-system
  labels:
    app: bank-credit-limit-agent
spec:
  ai:
    groups:
      # Priority 1 (highest): GPT-4.1 -- best quality for credit decisions
      - providers:
          - name: openai-gpt-41
            openai:
              model: gpt-4.1
            policies:
              auth:
                secretRef:
                  name: openai-secret
      # Priority 2: GPT-4o-mini -- good balance of cost and quality
      - providers:
          - name: openai-gpt-4o-mini
            openai:
              model: gpt-4o-mini
            policies:
              auth:
                secretRef:
                  name: openai-secret
      # Priority 3 (lowest): GPT-3.5-turbo -- lowest cost fallback
      - providers:
          - name: openai-gpt-35
            openai:
              model: gpt-3.5-turbo
            policies:
              auth:
                secretRef:
                  name: openai-secret
---
# Multi-provider failover: OpenAI + Anthropic for maximum resilience
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: bank-llm-multi-provider-failover
  namespace: agentgateway-system
  labels:
    app: bank-credit-limit-agent
spec:
  ai:
    groups:
      # Priority 1: Load balance across premium models from both providers
      - providers:
          - name: openai-gpt-41
            openai:
              model: gpt-4.1
            policies:
              auth:
                secretRef:
                  name: openai-secret
          - name: claude-sonnet
            anthropic:
              model: claude-sonnet-4-20250514
            policies:
              auth:
                secretRef:
                  name: anthropic-secret
      # Priority 2: Cheaper fallback models from both providers
      - providers:
          - name: openai-gpt-4o-mini
            openai:
              model: gpt-4o-mini
            policies:
              auth:
                secretRef:
                  name: openai-secret
          - name: claude-haiku
            anthropic:
              model: claude-3-5-haiku-latest
            policies:
              auth:
                secretRef:
                  name: anthropic-secret
---
# HTTPRoute for failover backend
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: bank-llm-failover
  namespace: agentgateway-system
  labels:
    app: bank-credit-limit-agent
spec:
  parentRefs:
    - name: agentgateway-proxy
      namespace: agentgateway-system
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /bank-llm
      backendRefs:
        - name: bank-llm-failover
          namespace: agentgateway-system
          group: agentgateway.dev
          kind: AgentgatewayBackend
